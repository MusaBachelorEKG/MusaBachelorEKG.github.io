<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EKG – Schüler Trainer</title>
  <style>
    /* ===== Farbwelt: klares Medizin‑Blau, hohe Lesbarkeit, ruhiger Kontrast ===== */
    :root{
      --bg:#08152c;         /* tiefer Hintergrund */
      --bg2:#0b1e3a;        /* Vollflächen-Hintergrund (konstant, kein Verlauf) */
      --surface:#0e2a57;    /* Flächenblau */
      --card:#0f2f62;       /* Karten */
      --ink:#e9eef9;        /* Primärtext */
      --muted:#b7c3d9;      /* Sekundärtext */
      --line:#1d4d9b;       /* Umrandungen */
      --accent:#58a9ff;     /* UI-Akzent (helles Blau) */
      --accent-2:#22c55e;   /* Bestätigen */
      --danger:#ff6b6b;     /* Fehler */
      --ok:#2bb673;         /* OK/Hinweise */
      --warn:#f59e0b;       /* Warnung */
    }

    *{box-sizing:border-box}
    html{min-height:100%; background: var(--bg2);} 
    body{min-height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;font-size:14px;background:transparent;color:var(--ink)}

    /* ===== Header: ruhig, mit EKG-Linie als thematisches Element ===== */
    header{position:static;background:rgba(8,21,44,.86);border-bottom:1px solid var(--line)}
    .wrap{max-width:1180px;margin:0 auto;padding:14px 16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    .title{font-size:20px;margin:0;font-weight:800;letter-spacing:.2px}
    .subtle{color:var(--muted);font-size:12px}

    /* EKG Linie */
    .ecg-bar{position:relative;height:24px;margin-top:8px;border-top:1px solid var(--line);overflow:hidden}
    .ecg-bar::after{content:"";position:absolute;left:-20%;top:50%;height:2px;width:140%;background:linear-gradient(90deg, transparent 0 5%, var(--accent) 15% 25%, transparent 35% 100%);
      transform:translateY(-50%);filter:drop-shadow(0 0 6px rgba(88,169,255,.55));animation:run 2.6s linear infinite}
    @keyframes run{from{left:-40%}to{left:0%}}

    main{padding:20px 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 12px 30px rgba(0,0,0,.28)}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    select,input[type="file"],input[type="text"],textarea{background:#0b1f41;color:var(--ink);border:1px solid var(--line);border-radius:12px}
    select,input[type="file"]{padding:10px 12px}

    button{border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;background:#0b254f;color:var(--ink);
      transition:transform .06s ease,opacity .2s ease,background .2s ease,box-shadow .2s ease}
    button:hover{transform:translateY(-1px);opacity:.96;box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .btn-accent{background:var(--accent);color:#04182d}
    .btn-success{background:var(--accent-2);color:#052e16}
    .btn-ghost{background:transparent;border:1px solid var(--line)}
    .btn-ghost[disabled]{opacity:.55;cursor:not-allowed;box-shadow:none;transform:none}
    .btn-danger{background:var(--danger);color:#fff}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0b2146;border:1px solid var(--line);color:var(--muted);font-size:12px}
    .small{font-size:12px;color:var(--muted)} .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--danger)}
    .spacer{height:10px}

    .grid{display:grid;gap:16px}
    @media (min-width:920px){.grid{grid-template-columns:1fr 2fr}}
    .grid-1{display:grid;grid-template-columns:1fr;gap:12px}

    textarea{width:100%;min-height:92px;padding:10px}
    textarea[disabled]{opacity:.65;pointer-events:none}
    input[disabled]{opacity:.65;pointer-events:none}

    .imgbox{background:#0b1f41;border:1px dashed var(--line);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:10px;justify-content:flex-start;align-items:center;min-height:260px}
    .imgbox img{max-width:100%;max-height:420px;border-radius:12px;cursor:zoom-in;display:block}
    .hr{height:1px;background:var(--line);margin:8px 0 12px}

    /* ===== MC-Bereich ===== */
    .mc{display:none;margin-top:8px;background:#0b2146;border:1px solid var(--line);border-radius:12px;padding:12px}
    .mc.show{display:block}
    .mc label{display:block;padding:10px;border:1px solid var(--line);border-radius:10px;margin:8px 0;background:#0a1e3f;cursor:pointer}

    .banner{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0b2146;margin-top:10px;display:none}
    .banner.warn{border-color:var(--warn)} .banner.error{border-color:var(--danger)}

    #diag{margin-top:8px;display:block}

    /* ===== Erklärungskasten – füllt freien Raum im Aside ===== */
    main .grid > aside.card{ display:flex; flex-direction:column; }
    main .grid > aside.card > #caseList{ flex:0 0 auto; }
    #explanationBox{ margin-top:16px; overflow:auto; background:#0b2146; border:1px solid var(--line); border-radius:12px; padding:12px; color:var(--ink); font-size:13px; display:none; flex:1 1 auto; min-height:200px; max-height:none }
    #explanationBox .title{ font-size:14px; font-weight:bold; margin-bottom:6px; color:var(--ok) }
    #explanationText{ white-space:pre-wrap; line-height:1.55; overflow-wrap:anywhere; word-break:break-word; }

    /* ===== Intro-Text größer/lesbar ===== */
    .introText{ font-size:16px; line-height:1.6; color:var(--ink); white-space:pre-wrap; }

    /* ===== Overlays – klar, ohne Glas; starker weißer Rahmen am Dialog ===== */
    .overlay{ position:fixed; inset:0; z-index:999; display:grid; place-items:center; padding:20px; background:rgba(7,12,20,.94); transition: opacity .25s ease, visibility .25s ease; }
    .overlay.hidden{ opacity:0; visibility:hidden; pointer-events:none }
    .scroll-lock{ overflow:hidden; padding-right: var(--sbw, 0px); }
    .modal{ background:#0e2146; border:4px solid #ffffff; border-radius:18px; padding:22px; max-width:520px; width:100%; box-shadow:0 20px 60px rgba(0,0,0,.5) }
    .modal h2{margin:.2rem 0 .6rem 0;font-size:18px}
    .modal p{margin:.1rem 0 1rem 0;color:var(--muted)}
    label{display:block;margin:10px 0 6px 2px}
    input[type="text"]{width:100%;border-radius:12px;border:1px solid var(--line);background:#0b1f41;color:var(--ink);padding:12px 14px;outline:none;caret-color:var(--accent);margin-bottom:12px}
    input[type="text"]::placeholder{ color: var(--muted); opacity:.85 }
    input[type="text"]:focus{border-color:var(--accent)}
    .modal .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:20px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;background:#0a1e3f;border:1px solid var(--line);border-bottom-width:2px;padding:1px 6px;border-radius:6px;font-size:12px;color:var(--muted)}

    /* ===== Bildviewer (Zoom) – blaue UI ===== */
    #imgViewer{position:relative;width:min(96vw,1400px);height:min(90vh,900px);background:#0b2146;border:1px solid var(--line);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.45);overflow:hidden}
    #imgCanvas{position:absolute;inset:0;cursor:grab}
    #imgCanvas.grabbing{cursor:grabbing}
    #imgCanvas img{position:absolute;top:50%;left:50%;transform:translate(calc(-50% + 0px), calc(-50% + 0px)) scale(1);transform-origin:center center;user-select:none;pointer-events:none;max-width:none;max-height:none}
    .imgControls{position:absolute;right:12px;bottom:12px;display:flex;gap:8px}
    .imgControls button{background:#0a1e3f;border:1px solid var(--line)}
    .imgTopBar{position:absolute;left:12px;top:12px;display:flex;gap:8px;align-items:center}
    .imgTopBar .pill{background:#0a1e3f;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .closeBtn{position:absolute;top:12px;right:12px}

    /* End-Screen Overlay */
    #endOverlay .end-card{background:#0e2146;border:4px solid #ffffff;border-radius:18px;padding:28px;max-width:640px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.55);text-align:center}
    #endOverlay .end-banner{background:linear-gradient(135deg, rgba(88,169,255,.16), rgba(34,197,94,.18));border:1px solid var(--accent);border-radius:14px;padding:18px 16px;font-size:20px;font-weight:800;color:var(--ink);margin-bottom:14px}
    #endOverlay p{color:var(--muted);font-size:16px;line-height:1.6;margin:10px 0 18px 0;white-space:pre-line}

    /* Profil-Overlay Hintergrund bleibt dunkel, ohne Blur */
    #overlay{ background:rgba(7,10,16,.96); }

    /* Feldaktionen: Button-Gruppen für Ja/Nein & Auswahlfelder */
    .choice-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .choice-row button.active{background:var(--accent);color:#04182d}
    .lead-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:6px;margin-top:10px;background:#0b1f41;border:1px solid var(--line);border-radius:12px;padding:10px}
    .lead-grid button{width:100%;padding:8px 10px}
    .lead-grid button.active{background:var(--accent-2);color:#052e16}
    .small-note{color:var(--muted);font-size:12px;margin-top:4px}
  </style>
  <!-- Google tag (gtag.js) für Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-G619CFWZG3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-G619CFWZG3');
  </script>
  <!-- Firebase: kompatible Bundles für einfache Einbindung ohne Build-Tool -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <div class="title">EKG-Analysen</div>
          <span class="badge" id="statusBadge">Screening: offen</span>
        </div>
      </div>
      <div class="ecg-bar" aria-hidden="true"></div>
      <div class="spacer"></div>
      <div class="row card" style="gap:10px">
        <div class="toolbar" style="flex:1 1 auto">
          <button id="showCases" class="btn-accent">5 EKG-Fälle anzeigen</button>
          <button id="syncNow" class="btn-ghost">Daten online speichern</button>
        </div>
        <span class="badge" id="syncStatus">Online Sync: nicht konfiguriert</span>
      </div>
      <div id="banner" class="banner"></div>
      <div id="diag" class="small"></div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <aside class="card">
        <div class="small">EKG-Fälle</div>
        <div id="caseList" class="grid-1"></div>
        <div id="explanationBox">
          <div class="title">Warum richtig?</div>
          <div id="explanationText"></div>
        </div>
      </aside>
      <section class="card">
        <div id="caseView">
          <div class="small">Fälle sind bereits geladen. Wähle einen <b>Fall</b>, um zu starten.</div>
        </div>
      </section>
    </div>
  </main>

  <!-- Integrierte Falldaten -->
  <script src="cases-data.js"></script>

  <!-- Overlay: Screening-Fragen -->
  <div class="overlay hidden" id="overlay">
    <div class="modal">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <div>
          <h2>Screening vor dem Test</h2>
          <p>Bitte beantworte die folgenden Fragen. Nur passende Teilnehmende können fortfahren.</p>
        </div>
      </div>
      <div id="screeningBox">
        <div class="small" id="progressText">Frage 1 von 3</div>
        <div style="font-size:16px;font-weight:700" id="questionText"></div>
        <div class="actions" style="justify-content:flex-start">
          <button type="button" class="btn-success" id="answerYes">Ja</button>
          <button type="button" class="btn-danger" id="answerNo">Nein</button>
        </div>
        <p class="small">Wenn eine Antwort nicht passt, wird der Test automatisch beendet.</p>
      </div>
      <div id="screeningResult" style="display:none;">
        <div class="badge" style="background:rgba(255,107,107,.12);color:var(--danger);border-color:var(--danger)">Keine Teilnahme möglich</div>
        <p id="resultText" class="small" style="color:var(--ink);margin-top:10px"></p>
        <div class="actions" style="justify-content:flex-end;margin-top:12px">
          <button type="button" class="btn-ghost" id="cancelOverlay">Schließen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bildviewer Overlay -->
  <div class="overlay hidden" id="imgOverlay" aria-hidden="true">
    <div id="imgViewer">
      <button class="btn-ghost closeBtn" id="imgClose" title="Schließen">✕</button>
      <div class="imgTopBar"><span class="pill" id="zoomInfo">100 %</span></div>
      <div id="imgCanvas"><img id="zoomImg" alt="EKG"></div>
      <div class="imgControls">
        <button class="btn-ghost" id="zoomOut" title="Verkleinern">−</button>
        <button class="btn-ghost" id="zoomReset" title="Zurücksetzen">100%</button>
        <button class="btn-ghost" id="zoomIn" title="Vergrößern">+</button>
      </div>
    </div>
  </div>

  <!-- End-Screen Overlay -->
  <div class="overlay hidden" id="endOverlay" aria-live="polite">
    <div class="end-card">
      <div class="end-banner" id="endTitle">Herzlichen Dank für die Teilnahme!</div>
      <p id="endSubtitle">Deine Daten sind erfolgreich hochgeladen worden.
Sie können nun das Fenster schließen.

Liebe Grüße
Abed El Rahim, Musa</p>
      <div class="actions" style="justify-content:center;gap:10px;flex-wrap:wrap">
        <button type="button" class="btn-ghost" id="endRestart">Neu starten</button>
        <button type="button" class="btn-ghost" id="endClose">Schließen</button>
      </div>
    </div>
  </div>

  <!-- Vorzeitige Sync-Bestätigung -->
  <div class="overlay hidden" id="earlySyncOverlay" aria-live="polite">
    <div class="modal">
      <h2>Vorzeitige Abgabe?</h2>
      <p>Sind Sie sicher, dass Sie vorzeitig abgeben wollen? Es ist wichtig für eine gute Auswertung, dass so viel wie möglich interpretiert wird.</p>
      <div class="actions" style="justify-content:flex-end">
        <button type="button" class="btn-ghost" id="earlySyncContinue">Ja, ich möchte weiter machen</button>
        <button type="button" class="btn-danger" id="earlySyncConfirm">Ja, ich möchte vorzeitig beenden</button>
      </div>
    </div>
  </div>

<script>
// ===== Scroll-Lock Helpers =====
let __overlayLocks = 0;
function lockScroll(){
  __overlayLocks++;
  if(__overlayLocks === 1){
    const sbw = window.innerWidth - document.documentElement.clientWidth;
    document.documentElement.style.setProperty('--sbw', sbw + 'px');
    document.body.classList.add('scroll-lock');
  }
}
function unlockScroll(){
  if(__overlayLocks > 0) __overlayLocks--;
  if(__overlayLocks === 0){
    document.body.classList.remove('scroll-lock');
    document.documentElement.style.removeProperty('--sbw');
  }
}

/* ========= Profil: lokale Verschlüsselung (AES-GCM) ========= */
const PASS_PHRASE = "ekg-app-local-protect-v1";
const SALT_STR = "ekg-student-salt-2025";
const enc = new TextEncoder(); const dec = new TextDecoder();
function strToBytes(str){ return enc.encode(str); }
function bytesToB64(bytes){ let bin=""; bytes.forEach(b=>bin+=String.fromCharCode(b)); return btoa(bin); }
function b64ToBytes(b64){ const bin=atob(b64); const out=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) out[i]=bin.charCodeAt(i); return out; }
async function getKey(){
  const keyMaterial = await crypto.subtle.importKey("raw", strToBytes(PASS_PHRASE), "PBKDF2", false, ["deriveKey"]);
  return crypto.subtle.deriveKey({ name:"PBKDF2", salt:strToBytes(SALT_STR), iterations:120000, hash:"SHA-256" },
    keyMaterial, { name:"AES-GCM", length:256 }, false, ["encrypt","decrypt"]);
}
async function encryptString(plainText){
  const key = await getKey();
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const cipherBuf = await crypto.subtle.encrypt({ name:"AES-GCM", iv }, key, strToBytes(plainText));
  const data = new Uint8Array(iv.length + cipherBuf.byteLength);
  data.set(iv,0); data.set(new Uint8Array(cipherBuf), iv.length);
  return bytesToB64(data);
}
async function decryptString(payloadB64){
  const data = b64ToBytes(payloadB64); const iv=data.slice(0,12); const cipher=data.slice(12);
  const key = await getKey();
  const plainBuf = await crypto.subtle.decrypt({ name:"AES-GCM", iv }, key, cipher);
  return dec.decode(plainBuf);
}
const PROFILE_KEY = "ekg_student_profile_v2";
async function saveProfile(status, answers, reason=''){
  const answersEnc = await encryptString(JSON.stringify(answers||{}));
  const statusEnc = await encryptString(status);
  const reasonEnc = await encryptString(reason);
  localStorage.setItem(PROFILE_KEY, JSON.stringify({v:2,statusEnc,answersEnc,reasonEnc}));
}
async function loadProfile(){
  const raw = localStorage.getItem(PROFILE_KEY);
  if(!raw) return null;
  try{
    const obj = JSON.parse(raw);
    const status = await decryptString(obj.statusEnc);
    const answers = JSON.parse(await decryptString(obj.answersEnc) || '{}');
    const reason = await decryptString(obj.reasonEnc);
    return {status, answers, reason};
  }catch(e){ console.error("Profil konnte nicht entschlüsselt werden:", e); return null; }
}
function clearProfile(){ localStorage.removeItem(PROFILE_KEY); }

/* ========= Elemente ========= */
  const els = {
  list: document.getElementById('caseList'),
  view: document.getElementById('caseView'),
  showCases: document.getElementById('showCases'),
  syncNow: document.getElementById('syncNow'),
  syncStatus: document.getElementById('syncStatus'),
  banner: document.getElementById('banner'),
  diag: document.getElementById('diag'),
  statusBadge: document.getElementById('statusBadge'),
  explanationBox: document.getElementById('explanationBox'),
  explanationText: document.getElementById('explanationText'),
  imgOverlay: document.getElementById('imgOverlay'),
  imgViewer: document.getElementById('imgViewer'),
  imgCanvas: document.getElementById('imgCanvas'),
  zoomImg: document.getElementById('zoomImg'),
  zoomInfo: document.getElementById('zoomInfo'),
  zoomIn: document.getElementById('zoomIn'),
  zoomOut: document.getElementById('zoomOut'),
  zoomReset: document.getElementById('zoomReset'),
  imgClose: document.getElementById('imgClose'),
  endOverlay: document.getElementById('endOverlay'),
  endTitle: document.getElementById('endTitle'),
  endSubtitle: document.getElementById('endSubtitle'),
  endClose: document.getElementById('endClose'),
  endRestart: document.getElementById('endRestart'),
  earlySyncOverlay: document.getElementById('earlySyncOverlay'),
  earlySyncContinue: document.getElementById('earlySyncContinue'),
  earlySyncConfirm: document.getElementById('earlySyncConfirm'),
};
const FIREBASE_COLLECTION = 'MusaBachelor-EKG-Datensätze';
const SESSION_ID_KEY = 'ekgSessionUuid';
let firebaseApp = null;
let firestoreDb = null;
let isSyncInFlight = false;
let firebaseAnalytics = null;
let syncDisabled = false;
let firestoreProbeDone = false;

function hasFirebaseConfig(cfg){
  return !!(cfg && cfg.apiKey && cfg.projectId && cfg.appId);
}

function ensureSessionId(){
  const existing = localStorage.getItem(SESSION_ID_KEY);
  if(existing){ return existing; }
  const uuid = crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(16).slice(2)}`;
  localStorage.setItem(SESSION_ID_KEY, uuid);
  return uuid;
}

function renderSyncStatus(state){
  if(!els.syncStatus) return;
  if(syncDisabled){
    els.syncStatus.textContent = 'Online Sync: deaktiviert';
    els.syncStatus.style.color = 'var(--muted)';
    els.syncStatus.style.borderColor = 'var(--line)';
    els.syncNow.disabled = true;
    return;
  }
  if(state === 'uploading'){
    els.syncStatus.textContent = 'Online Sync: wird übertragen…';
    els.syncStatus.style.color = 'var(--accent)';
    els.syncStatus.style.borderColor = 'var(--accent)';
    els.syncNow.disabled = true;
    return;
  }
  if(!hasFirebaseConfig(firebaseConfig)){
    els.syncStatus.textContent = 'Online Sync: nicht konfiguriert';
    els.syncStatus.style.color = 'var(--muted)';
    els.syncStatus.style.borderColor = 'var(--line)';
    els.syncNow.disabled = true;
    return;
  }
  els.syncNow.disabled = false;
  const sentAll = !!progress.__syncAllSent;
  const isError = state === 'error';
  els.syncStatus.textContent = sentAll ? 'Online Sync: übermittelt' : 'Online Sync: bereit';
  els.syncStatus.style.color = isError ? 'var(--danger)' : (sentAll ? 'var(--ok)' : 'var(--ink)');
  els.syncStatus.style.borderColor = isError ? 'var(--danger)' : 'var(--accent)';
}

function ensureFirebase(){
  if(firestoreDb) return firestoreDb;
  if(!hasFirebaseConfig(firebaseConfig) || !window.firebase){
    console.warn('Firebase ist nicht konfiguriert.');
    return null;
  }
  firebaseApp = firebase.initializeApp(firebaseConfig);
  firestoreDb = firebase.firestore();
  try{
    if(firebase.analytics && firebaseConfig.measurementId){
      firebaseAnalytics = firebase.analytics();
      firebaseAnalytics.logEvent('page_view');
      console.info('Firebase Analytics aktiviert');
    }
  }catch(e){
    console.warn('Firebase Analytics konnte nicht initialisiert werden:', e);
  }
  return firestoreDb;
}

async function verifyFirestoreAccess(){
  if(firestoreProbeDone || syncDisabled) return;
  const db = ensureFirebase();
  if(!db){
    renderSyncStatus('error');
    return;
  }
  try {
    const probeDoc = db.collection(FIREBASE_COLLECTION).doc('__connectivity__');
    await probeDoc.set({
      lastChecked: firebase.firestore.FieldValue.serverTimestamp(),
      clientSession: ensureSessionId(),
      type: 'connectivity-check',
    }, { merge: true });
    firestoreProbeDone = true;
    renderSyncStatus();
  } catch (err) {
    console.error('Firestore Probe fehlgeschlagen:', err);
    showBanner('Firebase Firestore ist nicht erreichbar. Bitte Einstellungen und Internet prüfen.', 'error');
    renderSyncStatus('error');
  }
}

function initFirebaseLink(){
  if(syncDisabled) return;
  if(!hasFirebaseConfig(firebaseConfig)){
    renderSyncStatus('error');
    return;
  }
  try{
    const db = ensureFirebase();
    if(db){
      console.info('Firebase verbunden mit Projekt:', firebaseConfig.projectId);
      renderSyncStatus();
    } else {
      renderSyncStatus('error');
    }
  }catch(e){
    console.error('Firebase-Initialisierung fehlgeschlagen:', e);
    showBanner('Firebase konnte nicht initialisiert werden. Bitte Konfiguration prüfen.', 'error');
    renderSyncStatus('error');
  }
}

function buildSubmissionPayload(){
  const cases = allCases.map(c=>{
    const entry = progress[c.id] || {};
    return {
      id: c.id,
      title: c.title,
      submitted: !!entry.submitted,
      submittedAt: entry.submittedAt || null,
      submittedAtTs: entry.submittedAt ? firebase.firestore.Timestamp.fromDate(new Date(entry.submittedAt)) : null,
      answers: entry.answers || {},
    };
  });
  const tableRows = cases.map(row=>({
    id: row.id,
    title: row.title,
    ventr_frequenz: row.answers?.ventr_frequenz ?? '',
    qrs_rhythmik: row.answers?.qrs_rhythmik ?? '',
    qrs_breite: row.answers?.qrs_breite ?? '',
    vorhofaktivitaet: row.answers?.vorhofaktivitaet ?? '',
    av_kopplung: row.answers?.av_kopplung ?? '',
    st_strecke: formatStAnswer(row.answers?.st_strecke),
    interpretation: row.answers?.interpretation ?? '',
    submitted: row.submitted,
    submittedAt: row.submittedAt,
    submittedAtTs: row.submittedAtTs,
  }));
  return {
    sessionId: ensureSessionId(),
    createdAt: firebase.firestore.Timestamp.now(),
    cases,
    nestedCases: cases,
    tableRows,
    flatTableRows: tableRows,
    completedCases: cases.filter(x=>x.submitted).length,
    allSubmitted: cases.length ? cases.every(x=>x.submitted) : false,
    screening: {...qAnswers},
    formats: {
      nested: 'nestedCases',
      tabular: 'flatTableRows',
    },
  };
}

function showEarlySyncPrompt(){
  if(!els.earlySyncOverlay){
    showBanner('Bitte bearbeite möglichst alle 5 Fälle vor der Online-Speicherung.', 'warn');
    return;
  }
  els.earlySyncOverlay.classList.remove('hidden');
  lockScroll();
}

function hideEarlySyncPrompt(){
  if(!els.earlySyncOverlay) return;
  els.earlySyncOverlay.classList.add('hidden');
  unlockScroll();
}

async function syncAllSubmissions(manual=false, force=false){
  if(syncDisabled){
    showBanner('Online-Speicherung ist deaktiviert.', 'warn');
    return;
  }
    const db = ensureFirebase();
    if(!db){
      showBanner('Firebase ist nicht eingerichtet. Bitte Konfigurationsdaten eintragen.', 'warn');
      renderSyncStatus('error');
      return;
  }
  if(isSyncInFlight){ return; }
  if(manual && !force && !allCasesSubmitted()){
    showEarlySyncPrompt();
    return;
  }
  isSyncInFlight = true;
  renderSyncStatus('uploading');
  showBanner('Daten werden online gespeichert. Bitte warten…');
    try{
      const payload = buildSubmissionPayload();
      const profile = await loadProfile();
      payload.profileStatus = profile?.status || 'unknown';
      payload.sessionDocId = payload.sessionId;
      const docRef = db.collection(FIREBASE_COLLECTION).doc(payload.sessionId);
      const writePromise = docRef.set({
        ...payload,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        clientCreatedAt: payload.createdAt,
      });
      const timeoutMs = 15000;
      await Promise.race([
        writePromise,
        new Promise((_, rej) => setTimeout(() => rej(new Error('Timeout bei der Online-Übertragung. Bitte Internet prüfen.')), timeoutMs)),
      ]);
    progress.__syncAllSent = payload.allSubmitted;
    saveProgress();
    renderSyncStatus();
    const reason = manual ? '' : ' (alle 5 Fälle abgegeben)';
    showBanner('Daten wurden online gespeichert'+reason+'.');
    if(payload.allSubmitted || manual){
      showEndScreen('success');
    }
  }catch(e){
    console.error('Sync fehlgeschlagen:', e);
    showBanner('Konnte Daten nicht an Firebase senden: '+(e?.message||e), 'error');
    showEndScreen('error');
    renderSyncStatus('error');
  }finally{
    els.syncNow.disabled = false;
    isSyncInFlight = false;
    if(!progress.__syncAllSent){
      renderSyncStatus();
    }
  }
}

function allCasesSubmitted(){
  return allCases.length > 0 && allCases.every(c=>progress[c.id]?.submitted);
}

function maybeSyncAfterSubmission(){
  if(allCasesSubmitted() && !progress.__syncAllSent){
    syncAllSubmissions();
  } else {
    renderSyncStatus();
  }
}

/* ========= Firebase (online Speicherung) ========= */
// Firebase Web-Konfiguration (bereitgestellt)
const firebaseConfig = window.FIREBASE_CONFIG || {
  apiKey: 'AIzaSyBi_FTaRZQDp6CK82VnvvR_B_4bi10WJDY',
  authDomain: 'musabachelor-ekg.firebaseapp.com',
  projectId: 'musabachelor-ekg',
  storageBucket: 'musabachelor-ekg.firebasestorage.app',
  messagingSenderId: '987763555706',
  appId: '1:987763555706:web:7b7a5206c1bae20512eac3',
  measurementId: 'G-G619CFWZG3',
};
// ASCII-Schreibweise vermeiden Regel-Parser-Fehler in Firestore (keine Umlaute im Pfad)
const FIREBASE_COLLECTION = 'MusaBachelor-EKG-Datensaetze';
const SESSION_ID_KEY = 'ekgSessionUuid';
let firebaseApp = null;
let firestoreDb = null;
let isSyncInFlight = false;
let firebaseAnalytics = null;
let syncDisabled = false;
let firestoreProbeDone = false;

function hasFirebaseConfig(cfg){
  return !!(cfg && cfg.apiKey && cfg.projectId && cfg.appId);
}

function ensureSessionId(){
  const existing = localStorage.getItem(SESSION_ID_KEY);
  if(existing){ return existing; }
  const uuid = crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(16).slice(2)}`;
  localStorage.setItem(SESSION_ID_KEY, uuid);
  return uuid;
}

function renderSyncStatus(state){
  if(!els.syncStatus) return;
  if(syncDisabled){
    els.syncStatus.textContent = 'Online Sync: deaktiviert';
    els.syncStatus.style.color = 'var(--muted)';
    els.syncStatus.style.borderColor = 'var(--line)';
    els.syncNow.disabled = true;
    return;
  }
  if(state === 'uploading'){
    els.syncStatus.textContent = 'Online Sync: wird übertragen…';
    els.syncStatus.style.color = 'var(--accent)';
    els.syncStatus.style.borderColor = 'var(--accent)';
    els.syncNow.disabled = true;
    return;
  }
  if(!hasFirebaseConfig(firebaseConfig)){
    els.syncStatus.textContent = 'Online Sync: nicht konfiguriert';
    els.syncStatus.style.color = 'var(--muted)';
    els.syncStatus.style.borderColor = 'var(--line)';
    els.syncNow.disabled = true;
    return;
  }
  els.syncNow.disabled = false;
  const sentAll = !!progress.__syncAllSent;
  const isError = state === 'error';
  els.syncStatus.textContent = sentAll ? 'Online Sync: übermittelt' : 'Online Sync: bereit';
  els.syncStatus.style.color = isError ? 'var(--danger)' : (sentAll ? 'var(--ok)' : 'var(--ink)');
  els.syncStatus.style.borderColor = isError ? 'var(--danger)' : 'var(--accent)';
}

function ensureFirebase(){
  if(firestoreDb) return firestoreDb;
  if(!hasFirebaseConfig(firebaseConfig) || !window.firebase){
    console.warn('Firebase ist nicht konfiguriert.');
    return null;
  }
  firebaseApp = firebase.initializeApp(firebaseConfig);
  firestoreDb = firebase.firestore();
  try{
    if(firebase.analytics && firebaseConfig.measurementId){
      firebaseAnalytics = firebase.analytics();
      firebaseAnalytics.logEvent('page_view');
      console.info('Firebase Analytics aktiviert');
    }
  }catch(e){
    console.warn('Firebase Analytics konnte nicht initialisiert werden:', e);
  }
  return firestoreDb;
}

async function verifyFirestoreAccess(){
  if(firestoreProbeDone || syncDisabled) return;
  const db = ensureFirebase();
  if(!db){
    renderSyncStatus('error');
    return;
  }
  try {
    const probeDoc = db.collection(FIREBASE_COLLECTION).doc('__connectivity__');
    await probeDoc.set({
      lastChecked: firebase.firestore.FieldValue.serverTimestamp(),
      clientSession: ensureSessionId(),
      type: 'connectivity-check',
    }, { merge: true });
    firestoreProbeDone = true;
    renderSyncStatus();
  } catch (err) {
    console.error('Firestore Probe fehlgeschlagen:', err);
    if(err?.code === 'permission-denied'){
      showBanner('Firebase Firestore verweigert den Zugriff (fehlende Schreibrechte). Bitte Firestore-Regeln auf "write-only" ohne Auth setzen.', 'error');
    } else {
      showBanner('Firebase Firestore ist nicht erreichbar. Bitte Einstellungen und Internet prüfen.', 'error');
    }
    renderSyncStatus('error');
  }
}

function initFirebaseLink(){
  if(syncDisabled) return;
  if(!hasFirebaseConfig(firebaseConfig)){
    renderSyncStatus('error');
    return;
  }
  try{
    const db = ensureFirebase();
    if(db){
      console.info('Firebase verbunden mit Projekt:', firebaseConfig.projectId);
      renderSyncStatus();
    } else {
      renderSyncStatus('error');
    }
  }catch(e){
    console.error('Firebase-Initialisierung fehlgeschlagen:', e);
    showBanner('Firebase konnte nicht initialisiert werden. Bitte Konfiguration prüfen.', 'error');
    renderSyncStatus('error');
  }
}

function buildSubmissionPayload(){
  const cases = allCases.map(c=>{
    const entry = progress[c.id] || {};
    return {
      id: c.id,
      title: c.title,
      submitted: !!entry.submitted,
      submittedAt: entry.submittedAt || null,
      submittedAtTs: entry.submittedAt ? firebase.firestore.Timestamp.fromDate(new Date(entry.submittedAt)) : null,
      answers: entry.answers || {},
    };
  });
  const tableRows = cases.map(row=>({
    id: row.id,
    title: row.title,
    ventr_frequenz: row.answers?.ventr_frequenz ?? '',
    qrs_rhythmik: row.answers?.qrs_rhythmik ?? '',
    qrs_breite: row.answers?.qrs_breite ?? '',
    vorhofaktivitaet: row.answers?.vorhofaktivitaet ?? '',
    av_kopplung: row.answers?.av_kopplung ?? '',
    st_strecke: formatStAnswer(row.answers?.st_strecke),
    interpretation: row.answers?.interpretation ?? '',
    submitted: row.submitted,
    submittedAt: row.submittedAt,
    submittedAtTs: row.submittedAtTs,
  }));
  return {
    sessionId: ensureSessionId(),
    createdAt: firebase.firestore.Timestamp.now(),
    cases,
    nestedCases: cases,
    tableRows,
    flatTableRows: tableRows,
    completedCases: cases.filter(x=>x.submitted).length,
    allSubmitted: cases.length ? cases.every(x=>x.submitted) : false,
    screening: {...qAnswers},
    formats: {
      nested: 'nestedCases',
      tabular: 'flatTableRows',
    },
  };
}

function showEarlySyncPrompt(){
  if(!els.earlySyncOverlay){
    showBanner('Bitte bearbeite möglichst alle 5 Fälle vor der Online-Speicherung.', 'warn');
    return;
  }
  els.earlySyncOverlay.classList.remove('hidden');
  lockScroll();
}

function hideEarlySyncPrompt(){
  if(!els.earlySyncOverlay) return;
  els.earlySyncOverlay.classList.add('hidden');
  unlockScroll();
}

async function syncAllSubmissions(manual=false, force=false){
  if(syncDisabled){
    showBanner('Online-Speicherung ist deaktiviert.', 'warn');
    return;
  }
  const db = ensureFirebase();
  if(!db){
    showBanner('Firebase ist nicht eingerichtet. Bitte Konfigurationsdaten eintragen.', 'warn');
    renderSyncStatus('error');
    return;
  }
  if(isSyncInFlight){ return; }
  if(manual && !force && !allCasesSubmitted()){
    showEarlySyncPrompt();
    return;
  }
  isSyncInFlight = true;
  renderSyncStatus('uploading');
  showBanner('Daten werden online gespeichert. Bitte warten…');
  try{
    const payload = buildSubmissionPayload();
    const profile = await loadProfile();
    payload.profileStatus = profile?.status || 'unknown';
    payload.sessionDocId = payload.sessionId;
    const docRef = db.collection(FIREBASE_COLLECTION).doc(payload.sessionId);
    const writePromise = docRef.set({
      ...payload,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      clientCreatedAt: payload.createdAt,
    });
    const timeoutMs = 15000;
    await Promise.race([
      writePromise,
      new Promise((_, rej) => setTimeout(() => rej(new Error('Timeout bei der Online-Übertragung. Bitte Internet prüfen.')), timeoutMs)),
    ]);
    progress.__syncAllSent = payload.allSubmitted;
    saveProgress();
    renderSyncStatus();
    const reason = manual ? '' : ' (alle 5 Fälle abgegeben)';
    showBanner('Daten wurden online gespeichert'+reason+'.');
    if(payload.allSubmitted || manual){
      showEndScreen('success');
    }
  }catch(e){
    console.error('Sync fehlgeschlagen:', e);
    if(e?.code === 'permission-denied'){
      showBanner('Konnte Daten nicht an Firebase senden: fehlende Schreibrechte. Bitte Firestore-Regeln auf "write-only" ohne Auth setzen.', 'error');
    } else {
      showBanner('Konnte Daten nicht an Firebase senden: '+(e?.message||e), 'error');
    }
    showEndScreen('error');
    renderSyncStatus('error');
  }finally{
    els.syncNow.disabled = false;
    isSyncInFlight = false;
    if(!progress.__syncAllSent){
      renderSyncStatus();
    }
  }
}

function allCasesSubmitted(){
  return allCases.length > 0 && allCases.every(c=>progress[c.id]?.submitted);
}

function maybeSyncAfterSubmission(){
  if(allCasesSubmitted() && !progress.__syncAllSent){
    syncAllSubmissions();
  } else {
    renderSyncStatus();
  }
}

/* ========= Banner ========= */
function showBanner(text, kind=''){ els.banner.textContent=text; els.banner.className='banner '+(kind||''); els.banner.style.display='block'; }

/* ========= End-Screen Overlay ========= */
function showEndScreen(state='success'){
  if(!els.endOverlay) return;
  const isSuccess = state === 'success';
  if(els.endTitle){
    els.endTitle.textContent = isSuccess
      ? 'Herzlichen Dank für die Teilnahme!'
      : 'Ups, die Übertragung war nicht erfolgreich.';
  }
  if(els.endSubtitle){
    els.endSubtitle.textContent = isSuccess
      ? 'Deine Daten sind erfolgreich hochgeladen worden.\nSie können nun das Fenster schließen.\n\nLiebe Grüße\nAbed El Rahim, Musa'
      : 'Ups. Es konnte nicht hochgeladen werden. Überprüfen Sie Ihren Internetzugang.';
  }
  els.endOverlay.classList.remove('hidden');
  lockScroll();
}

function hideEndScreen(){
  if(!els.endOverlay) return;
  els.endOverlay.classList.add('hidden');
  unlockScroll();
}

  function clearCachesForRestart(){
    syncDisabled = true;
    els.syncNow.disabled = true;
    renderSyncStatus('disabled');
    localStorage.removeItem(LS_KEY);
    localStorage.removeItem(SESSION_ID_KEY);
    clearProfile();
    Object.keys(progress).forEach((k) => delete progress[k]);
  }

function restartSession(){
  clearCachesForRestart();
  showBanner('Daten wurden zurückgesetzt. Die Seite wird neu geladen.');
  setTimeout(() => {
    window.location.reload();
  }, 250);
}

/* ========= Fälle/Progress ========= */
let allCases = [];
let currentCaseId = null;

const LS_KEY = 'ekgTrainerProgressV1';
const progress = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
function saveProgress(){ localStorage.setItem(LS_KEY, JSON.stringify(progress)); }

renderSyncStatus();
initFirebaseLink();
verifyFirestoreAccess();

function updateStats(){
    const finished = allCases.filter(hasAnswers).length;
    els.diag.innerHTML = `Geladen: <b>${allCases.length}</b> Fälle · Bearbeitet: <b>${finished}</b>`;
  }
function adjustExplanationHeight(){ const box=document.getElementById('explanationBox'); if(box){ box.style.maxHeight='none'; } }
window.addEventListener('resize', adjustExplanationHeight);

  function isFieldFilled(f, answers={}){
    if(f.fixed) return true;
    const val = answers[f.key];
  if(f.type === 'choice'){
    return typeof val === 'string' && val.trim().length>0;
  }
  if(f.type === 'st'){
    return !!(val && val.choice && (val.choice === 'Nein' || (Array.isArray(val.leads) && val.leads.length>0)));
    }
    return typeof val === 'string' && val.trim().length>0;
  }

  function hasAnswers(c){
    const answers = progress[c.id]?.answers || {};
    const fields = c.fields && c.fields.length ? c.fields : defaultFields();
    return fields.some(f=>!f.fixed && isFieldFilled(f, answers));
  }

  function renderCaseList(){
    if(allCases.length===0){ els.list.innerHTML='<div class="small">Keine Fälle.</div>'; return; }
    els.list.innerHTML = allCases.map(c=>{
      const entry = progress[c.id];
      const status = entry?.submitted
        ? `<span class="badge" style="background:rgba(34,197,94,.18);border-color:var(--accent-2);color:var(--ok)">abgegeben</span>`
        : (hasAnswers(c) ? `<span class="badge">bearbeitet</span>` : `<span class="badge">offen</span>`);
      return `<button data-id="${c.id}" class="btn-ghost" style="text-align:left;width:100%"><div class="small">Fall</div><div>${c.title}</div><div class="small">${status}</div></button>`;
    }).join('');
    [...els.list.querySelectorAll('button')].forEach(b=>b.addEventListener('click',()=>openCase(b.dataset.id)));
    adjustExplanationHeight();
  }

function buildImagesHTML(c){
  // Unterstützt neues Feld "images" (Array) und altes Feld "image" (String)
  if(Array.isArray(c.images) && c.images.length){
    return c.images.map(src=>`<img src="${src}" alt="EKG">`).join('');
  }
  if(c.image){
    return `<img src="${c.image}" alt="EKG">`;
  }
  return '<span class="muted">(Kein Bild angegeben)</span>';
}

    function openCase(id){
      currentCaseId = id;
      const c = allCases.find(x=>x.id==id);
      if(!c){ showBanner('Interner Fehler: Fall nicht gefunden','error'); return; }

      const progressEntry = progress[id] || { answers:{} };
      const isSubmitted = !!progressEntry.submitted;
      const dis = isSubmitted ? 'disabled' : '';
      const caseFields = (c.fields && c.fields.length) ? c.fields : defaultFields();

      const fieldsHtml = (c.fields||[]).map((f)=>{
        const pObj = progress[id]||{ answers:{} };
        if(f.fixed){
          const val = f.fixedValue ?? '';
          pObj.answers = pObj.answers || {}; pObj.answers[f.key] = val; progress[id] = pObj; saveProgress();
          return `<div><div class="small">${f.label}</div><div style="background:#0b1f41;border:1px solid var(--line);border-radius:12px;padding:10px;color:#cdd7eb">${val}</div></div>`;
        }
        const val = pObj.answers ? pObj.answers[f.key] : '';
        if(f.type === 'choice'){
          const selected = typeof val === 'string' ? val : '';
          const buttons = (f.options||[]).map(opt=>{
            const active = selected === opt ? 'active' : '';
            return `<button type="button" class="btn-ghost ${active}" data-type="choice" data-field="${f.key}" data-value="${opt}" ${dis}>${opt}</button>`;
          }).join('');
          return `<div data-field-block="${f.key}" data-field-type="choice"><div class="small">${f.label}</div><div class="choice-row">${buttons}</div></div>`;
        }
        if(f.type === 'st'){
          const valueObj = (val && typeof val === 'object') ? val : {choice:'', leads:[]};
          const yesActive = valueObj.choice === 'Ja' ? 'active' : '';
          const noActive = valueObj.choice === 'Nein' ? 'active' : '';
          const leads = ['I','II','III','aVR','aVL','aVF','V1','V2','V3','V4','V5','V6'];
          const leadButtons = leads.map(ld=>{
            const active = valueObj.leads?.includes(ld) ? 'active' : '';
            return `<button type="button" class="btn-ghost ${active}" data-lead="${ld}" ${dis}>${ld}</button>`;
          }).join('');
          const leadInfo = valueObj.leads?.length ? `Ausgewählt: ${valueObj.leads.join(', ')}` : 'Bitte wähle mindestens eine Ableitung.';
          const leadBlock = valueObj.choice === 'Ja'
            ? `<div class="lead-grid">${leadButtons}</div><div class="small-note">${leadInfo}</div>`
            : '';
          return `<div data-field-block="${f.key}" data-field-type="st"><div class="small">${f.label}</div><div class="choice-row"><button type="button" class="btn-ghost ${yesActive}" data-value="Ja" ${dis}>Ja</button><button type="button" class="btn-ghost ${noActive}" data-value="Nein" ${dis}>Nein</button></div>${leadBlock}</div>`;
        }
        if(f.type === 'number'){
        const numVal = typeof val === 'number' || (typeof val === 'string' && val.trim() !== '') ? val : '';
        return `<div><div class="small">${f.label}</div><input type="number" inputmode="numeric" pattern="[0-9]*" min="${f.min ?? 0}" max="${f.max ?? 230}" ${dis} data-key="${f.key}" data-type="number" placeholder="${f.placeholder||''}" value="${numVal}"></div>`;
      }
        const textVal = typeof val === 'string' ? val : '';
        return `<div><div class="small">${f.label}</div><textarea ${dis} data-key="${f.key}" placeholder="${f.placeholder||''}">${textVal}</textarea></div>`;
      }).join('');

      const submittedInfo = progressEntry.submittedAt ? new Date(progressEntry.submittedAt).toLocaleString('de-DE') : '';
      const submitBlock = `
        <div class="hr"></div>
        <div class="row" style="align-items:center;justify-content:space-between;margin-top:8px;gap:10px">
          <div class="small">${isSubmitted ? `Abgegeben am ${submittedInfo}` : 'Klicke auf Abgabe, um die Eingaben zu sperren.'}</div>
          <button type="button" class="btn-success" id="submitCase" ${isSubmitted ? 'disabled' : ''}>Abgabe</button>
        </div>`;

      els.view.innerHTML = `
        <div class="row" style="align-items:flex-start">
          <div>
            <div style="font-size:20px;font-weight:800">${c.title||''}</div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:16px">
          <div>
            <div class="small">Einleitung</div>
            <div class="introText">${c.intro||''}</div>
            <div class="spacer"></div>
            <div class="imgbox">${buildImagesHTML(c)}</div>
          </div>
          <div>
            <div class="small">Freitext-Interpretation</div>
            ${fieldsHtml}
            ${submitBlock}
          </div>
        </div>
      `;

      // === Bild-Click: alle Bilder anklickbar machen ===
      const imgEls = els.view.querySelectorAll('.imgbox img');
      imgEls.forEach(img => img.addEventListener('click', ()=> openImgViewer(img.src)));

      const submitBtn = document.getElementById('submitCase');
      const updateSubmitButtonState = ()=>{
        if(!submitBtn) return;
        const answers = progress[id]?.answers || {};
        const allFilled = caseFields.every(f=>isFieldFilled(f, answers));
        submitBtn.disabled = isSubmitted || !allFilled;
      };
      updateSubmitButtonState();

      els.explanationBox.style.display = 'none';
      els.explanationText.textContent = '';

      els.view.querySelectorAll('[data-key]').forEach(ctrl=>{
        ctrl.addEventListener('input',()=>{
          if(progress[id]?.submitted){ return; }
          const key = ctrl.dataset.key;
          let value = ctrl.value;
          if(ctrl.dataset.type === 'number'){
            value = value.replace(/[^0-9]/g,'');
            if(value === ''){
              progress[id] = progress[id] || {answers:{}};
              progress[id].answers[key] = '';
              ctrl.value = '';
              saveProgress();
              renderCaseList();
              updateStats();
              return;
            }
            const min = Number(ctrl.getAttribute('min')) || 0;
            const max = Number(ctrl.getAttribute('max')) || 230;
            let num = parseInt(value, 10);
            num = Math.min(max, Math.max(min, isNaN(num) ? min : num));
            value = String(num);
            ctrl.value = value;
          }
          progress[id] = progress[id] || {answers:{}};
          progress[id].answers[key] = value;
          saveProgress();
          renderCaseList();
          updateStats();
          updateSubmitButtonState();
        });
      });
      bindChoiceFields(id, c, updateSubmitButtonState);

      if(submitBtn){
        submitBtn.addEventListener('click', ()=>{
          progress[id] = progress[id] || {answers:{}};
          if(progress[id].submitted){ return; }
          progress[id].submitted = true;
          progress[id].submittedAt = new Date().toISOString();
          saveProgress();
          renderCaseList();
          showBanner('Fall wurde abgegeben. Änderungen sind gesperrt.', '');
          openCase(id);
          maybeSyncAfterSubmission();
        });
      }
    }
adjustExplanationHeight();

  function bindChoiceFields(id, c, onChange){
    if(progress[id]?.submitted){ return; }
    document.querySelectorAll('[data-field-type="choice"]').forEach(block=>{
      const fieldKey = block.getAttribute('data-field-block');
      block.querySelectorAll('button[data-type="choice"]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          progress[id] = progress[id] || {answers:{}};
          progress[id].answers[fieldKey] = btn.dataset.value;
          saveProgress();
          block.querySelectorAll('button[data-type="choice"]').forEach(b=>b.classList.toggle('active', b===btn));
          renderCaseList();
          updateStats();
          onChange?.();
        });
      });
    });

  document.querySelectorAll('[data-field-type="st"]').forEach(block=>{
      const fieldKey = block.getAttribute('data-field-block');
      const yesBtn = block.querySelector('button[data-value="Ja"]');
      const noBtn = block.querySelector('button[data-value="Nein"]');
      const ensureProgress = ()=>{
        progress[id] = progress[id] || {answers:{}};
        if(!progress[id].answers[fieldKey]){ progress[id].answers[fieldKey] = {choice:'', leads:[]}; }
      };
      const setChoice = (choice)=>{
        if(progress[id]?.submitted){ return; }
        ensureProgress();
        const current = progress[id].answers[fieldKey];
        const leads = choice === 'Ja' ? (current.leads || []) : [];
        progress[id].answers[fieldKey] = { choice, leads };
        saveProgress();
        if(choice === 'Nein' || (choice === 'Ja' && !block.querySelector('.lead-grid'))){
          renderCaseList();
          updateStats();
          openCase(id);
          onChange?.();
          return;
        }
        yesBtn?.classList.toggle('active', choice==='Ja');
        noBtn?.classList.toggle('active', choice==='Nein');
        updateLeadInfo(block, leads);
        renderCaseList();
        updateStats();
        onChange?.();
      };
      yesBtn?.addEventListener('click', ()=> setChoice('Ja'));
      noBtn?.addEventListener('click', ()=> setChoice('Nein'));

    block.querySelectorAll('[data-lead]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        if(progress[id]?.submitted){ return; }
        ensureProgress();
        const entry = progress[id].answers[fieldKey];
        if(entry.choice !== 'Ja'){ return; }
        const lead = btn.dataset.lead;
        const leads = new Set(entry.leads||[]);
        leads.has(lead) ? leads.delete(lead) : leads.add(lead);
          entry.leads = Array.from(leads);
          progress[id].answers[fieldKey] = entry;
          saveProgress();
          btn.classList.toggle('active');
          updateLeadInfo(block, entry.leads);
          renderCaseList();
          updateStats();
          onChange?.();
        });
      });
    });
  }

  function updateLeadInfo(block, leads){
    const note = block.querySelector('.small-note');
    if(!note) return;
    note.textContent = (leads && leads.length) ? `Ausgewählt: ${leads.join(', ')}` : 'Bitte wähle mindestens eine Ableitung.';
  }

  function formatStAnswer(val){
    if(!val) return '';
    if(typeof val === 'string') return val;
    if(val.choice === 'Nein') return 'Nein';
    if(val.choice === 'Ja'){
      const leads = Array.isArray(val.leads) ? val.leads.filter(Boolean) : [];
      return leads.length ? `Ja: ${leads.join(', ')}` : 'Ja';
    }
    return '';
  }

function defaultFields(){
  return [
    {key:'elektromechanik', label:'Elektrische und mechanische Aktivität vorhanden?', fixed:true, fixedValue:'Ja – 50mm/s Schreibgeschwindigkeit'},
    {key:'ventr_frequenz', label:'Ventrikuläre Frequenz (∕min)', type:'number', min:0, max:230, placeholder:'0–230'},
      {key:'qrs_rhythmik', label:'QRS-Komplexe: rhythmisch oder arrhythmisch?', type:'choice', options:['rhythmisch','arrhythmisch']},
      {key:'qrs_breite', label:'QRS-Komplexe: schmal oder breit?', type:'choice', options:['schmal','breit']},
      {key:'vorhofaktivitaet', label:'Vorhofaktivität vorhanden?', type:'choice', options:['Ja','Nein']},
      {key:'av_kopplung', label:'Kopplung zwischen Vorhof und Kammer?', type:'choice', options:['Ja','Nein']},
      {key:'st_strecke', label:'ST-Streckenhebung?', type:'st'},
      {key:'interpretation', label:'Zusammenfassende Interpretation', placeholder:'Hast du eine oder mehrere Diagnosen die du siehst, trag sie hier ein.'}
    ];
  }

function loadCases(json){
  try{
    if(!Array.isArray(json)){ showBanner('JSON muss ein Array sein.','error'); return; }
      const mapped = json.map((c,i)=>({
        id: c.id ?? (`case_${Date.now()}_${i}`),
        title: c.title ?? `EKG Fall ${i+1}`,
        intro: c.intro ?? '',
        // NEU: Mehrbild-Unterstützung (images-Array) + Fallback auf image-String
        images: Array.isArray(c.images) ? c.images : (c.image ? [c.image] : []),
        image: c.image ?? '',
        fields: (c.fields && c.fields.length)? c.fields : defaultFields()
      }));
    allCases = mapped;
    renderCaseList();
    updateStats();
    const first = allCases[0];
    if(first){ openCase(first.id); }
    els.explanationBox.style.display = 'none';
    els.explanationText.textContent = '';
  }catch(e){ showBanner('Fehler beim Laden der Fälle.','error'); }
}

/* ========= Event Handler ========= */
els.endClose?.addEventListener('click', hideEndScreen);
els.endOverlay?.addEventListener('click', e=>{ if(e.target === els.endOverlay){ hideEndScreen(); } });
els.endRestart?.addEventListener('click', restartSession);
els.earlySyncContinue?.addEventListener('click', ()=>{ hideEarlySyncPrompt(); showBanner('Bitte bearbeite möglichst alle 5 Fälle vor der Abgabe.', 'warn'); });
els.earlySyncConfirm?.addEventListener('click', ()=>{ hideEarlySyncPrompt(); syncAllSubmissions(true, true); });
els.earlySyncOverlay?.addEventListener('click', e=>{ if(e.target === els.earlySyncOverlay){ hideEarlySyncPrompt(); } });

els.showCases.addEventListener('click',()=>{
  renderCaseList();
  updateStats();
  if(currentCaseId){ openCase(currentCaseId); }
  else if(allCases[0]){ openCase(allCases[0].id); }
  document.getElementById('caseList').scrollIntoView({behavior:'smooth'});
});
els.syncNow.addEventListener('click', ()=> syncAllSubmissions(true));

/* Screening-Overlay */
const overlayEl = document.getElementById('overlay');
const progressTextEl = document.getElementById('progressText');
const questionTextEl = document.getElementById('questionText');
const answerYesEl = document.getElementById('answerYes');
const answerNoEl = document.getElementById('answerNo');
const screeningBoxEl = document.getElementById('screeningBox');
const screeningResultEl = document.getElementById('screeningResult');
const resultTextEl = document.getElementById('resultText');
const cancelOverlayEl = document.getElementById('cancelOverlay');

const questions = [
  { id:'bw', text:'Notfallsanitäter in Baden-Württemberg?', exitOn:'no', exitReason:'Leider gehörst du nicht zu der Probandengruppe für diese Bachelor Frage.' },
  { id:'jahr', text:'Bist du zu dem Zeitpunkt dieses Testes im 3. Ausbildungsjahr oder noch im 1. Berufsjahr?', exitOn:'no', exitReason:'Leider gehörst du nicht zu der Probandengruppe für diese Bachelor Frage.' },
  { id:'weiterbildung', text:'Hast du schon zertifizierte externe Weiterbildungen genutzt außerhalb des Schulischen Curriculum?', exitOn:'yes', exitReason:'Leider gehörst du nicht zu der Probandengruppe für diese Bachelor Frage.' },
];
let qIndex = 0;
let qAnswers = {};

function showQuestion(idx){
  const q = questions[idx];
  progressTextEl.textContent = `Frage ${idx+1} von ${questions.length}`;
  questionTextEl.textContent = q.text;
  screeningBoxEl.style.display = 'block';
  screeningResultEl.style.display = 'none';
}

function exitFlow(reason){
  resultTextEl.textContent = reason;
  screeningBoxEl.style.display = 'none';
  screeningResultEl.style.display = 'block';
  saveProfile('ineligible', qAnswers, reason);
  renderProfileUI({status:'ineligible', reason});
  lockScroll();
  overlayEl.classList.remove('hidden');
  showBanner(reason, 'error');
}

function completeFlow(){
  saveProfile('eligible', qAnswers, '');
  renderProfileUI({status:'eligible'});
  overlayEl.classList.add('hidden');
  unlockScroll();
  showBanner('Screening abgeschlossen. Viel Erfolg!');
}

function handleAnswer(isYes){
  const q = questions[qIndex];
  qAnswers[q.id] = isYes ? 'yes' : 'no';
  const triggersExit = (q.exitOn === 'yes' && isYes) || (q.exitOn === 'no' && !isYes);
  if(triggersExit){ exitFlow(q.exitReason); return; }
  if(qIndex === questions.length-1){ completeFlow(); return; }
  qIndex++; showQuestion(qIndex);
}

answerYesEl.addEventListener('click', ()=>handleAnswer(true));
answerNoEl.addEventListener('click', ()=>handleAnswer(false));

/* ========= Init ========= */
(async function enforceFirstRun(){
  const prof = await loadProfile();
  renderProfileUI(prof);
  qAnswers = prof?.answers || {};
  qIndex = 0;
  showQuestion(qIndex);
  if(!prof || prof.status === 'ineligible'){
    overlayEl.classList.remove('hidden');
    lockScroll();
    if(prof?.status === 'ineligible'){ resultTextEl.textContent = prof.reason || 'Keine Teilnahme möglich.'; screeningBoxEl.style.display='none'; screeningResultEl.style.display='block'; }
    showBanner('Bitte zuerst das Screening durchführen.', 'warn');
  }
})();
const embeddedCases = Array.isArray(window.EMBEDDED_CASES) ? window.EMBEDDED_CASES : [];
if(embeddedCases.length){
  loadCases(embeddedCases);
  showBanner('Integrierte Fälle geladen.');
} else {
  els.diag.innerHTML = 'Keine eingebetteten Fälle gefunden.';
}

cancelOverlayEl.addEventListener('click', async ()=>{
  const prof = await loadProfile();
  if(prof && prof.status !== 'ineligible'){ overlayEl.classList.add('hidden'); unlockScroll(); }
});

/* ========= UI Helpers ========= */
function renderProfileUI(prof){
  if(!prof){
    els.statusBadge.textContent = 'Screening: offen';
    els.statusBadge.style.background = '#0b2146';
    return;
  }
  if(prof.status === 'eligible'){
    els.statusBadge.textContent = 'Screening: freigegeben';
    els.statusBadge.style.background = 'rgba(34,197,94,.18)';
    els.statusBadge.style.color = 'var(--ok)';
  } else {
    els.statusBadge.textContent = 'Screening: blockiert';
    els.statusBadge.style.background = 'rgba(255,107,107,.18)';
    els.statusBadge.style.color = 'var(--danger)';
  }
}

/* ========= Bildviewer Logic ========= */
let z = 1, minZ = 0.5, maxZ = 8, posX = 0, posY = 0, isDrag = false, startX = 0, startY = 0;
function updateZoomDisplay(){ els.zoomInfo.textContent = Math.round(z*100) + ' %'; }
function openImgViewer(src){ els.zoomImg.src = src; els.imgOverlay.classList.remove('hidden'); lockScroll(); z=1; posX=0; posY=0; updateTransform(); updateZoomDisplay(); }
function closeImgViewer(){ els.imgOverlay.classList.add('hidden'); unlockScroll(); }
function updateTransform(){ els.zoomImg.style.transform = `translate(calc(-50% + ${posX}px), calc(-50% + ${posY}px)) scale(${z})`; }
els.imgOverlay.addEventListener('wheel', (e)=>{ if(e.target.closest('#imgViewer')){ e.preventDefault(); const delta=Math.sign(e.deltaY); const step=0.12; z=Math.min(maxZ, Math.max(minZ, z * (delta>0? (1-step):(1+step)))); updateTransform(); updateZoomDisplay(); } }, {passive:false});
els.imgCanvas.addEventListener('mousedown', (e)=>{ isDrag = true; startX = e.clientX - posX; startY = e.clientY - posY; els.imgCanvas.classList.add('grabbing'); });
window.addEventListener('mouseup', ()=>{ isDrag = false; els.imgCanvas.classList.remove('grabbing'); });
window.addEventListener('mousemove', (e)=>{ if(!isDrag) return; posX = e.clientX - startX; posY = e.clientY - startY; updateTransform(); });
els.imgCanvas.addEventListener('touchstart', (e)=>{ if(e.touches.length===1){ const t=e.touches[0]; isDrag=true; startX=t.clientX - posX; startY=t.clientY - posY; } });
els.imgCanvas.addEventListener('touchmove', (e)=>{ if(isDrag && e.touches.length===1){ const t=e.touches[0]; posX=t.clientX - startX; posY=t.clientY - startY; updateTransform(); } });
els.imgCanvas.addEventListener('touchend', ()=>{ isDrag=false; });
els.zoomIn.addEventListener('click', ()=>{ z=Math.min(maxZ, z*1.2); updateTransform(); updateZoomDisplay(); });
els.zoomOut.addEventListener('click', ()=>{ z=Math.max(minZ, z/1.2); updateTransform(); updateZoomDisplay(); });
els.zoomReset.addEventListener('click', ()=>{ z=1; posX=0; posY=0; updateTransform(); updateZoomDisplay(); });
els.imgClose.addEventListener('click', closeImgViewer);
els.imgOverlay.addEventListener('click', (e)=>{ if(e.target===els.imgOverlay) closeImgViewer(); });
</script>
</body>
</html>
